<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eindeepseek</title>
  <!-- 预加载群图，加速首屏 -->
  <link rel="preload" as="image" href="group.jpeg">
  <style>
    :root{
      --bg:#f7f8fa; --text:#222; --muted:#555; --primary:#2b7de9;
      --card:#fff; --border:#ddd; --ring:rgba(43,125,233,.18);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:#fff;border-bottom:1px solid var(--border)}
    .brand a{color:var(--text);text-decoration:none;font-weight:800;letter-spacing:.3px}
    .lang{display:inline-flex;gap:6px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:999px;padding:6px}
    .lang button{appearance:none;border:none;cursor:pointer;padding:6px 10px;border-radius:999px;color:var(--muted);background:transparent;font-weight:600}
    .lang button.active{color:#fff;background:var(--primary);box-shadow:0 0 0 6px var(--ring) inset}

    .wrap{max-width:1200px;margin:0 auto;padding:18px 16px 56px}
    h1{font-size:28px;margin:10px 0 8px}
    p.lead{color:var(--muted);margin:0 0 10px}

    .contactbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:6px 0 16px}
    .contactbar a,.contactbar span{background:#fff;border:1px solid var(--border);padding:8px 10px;border-radius:10px;color:var(--text);text-decoration:none;font-size:14px}
    .contactbar a:hover{background:#f1f5ff;border-color:#cfe0ff}

    .grid{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:18px}
    @media(min-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(min-width:960px){.grid{grid-template-columns:repeat(3,1fr)}}
    .card{position:relative;overflow:hidden;border-radius:14px;background:var(--card);border:1px solid var(--border);box-shadow:0 2px 10px rgba(0,0,0,.06);transform:translateY(8px);opacity:0;animation:rise .55s ease forwards}
    @keyframes rise{to{transform:none;opacity:1}}
    .thumb{aspect-ratio:4/3;width:100%;display:block;object-fit:cover;background:#f1f3f5}
    .body{padding:12px 14px 16px}
    .title{font-weight:800;margin:2px 0 6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#111}
    .desc{color:var(--muted);margin:0;line-height:1.55;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .badge{position:absolute;top:10px;left:10px;background:#111;color:#fff;padding:2px 8px;border-radius:999px;font-size:12px;opacity:.85}
    .cardlink{display:block;text-decoration:none;color:inherit}
    .qr-thumb{max-width:180px;max-height:180px;margin:16px auto;display:block;border-radius:10px;border:1px solid var(--border);background:#fff}
    footer{border-top:1px solid var(--border);text-align:center;padding:14px;color:var(--muted);margin-top:26px}
  </style>
</head>
<body>
  <header>
    <div class="brand"><a href="./">Eindeepseek</a></div>
    <div class="lang" id="langSwitcher">
      <button data-lang="zh">ZH</button>
      <button data-lang="en">EN</button>
      <button data-lang="de">DE</button>
    </div>
  </header>

  <div class="wrap">
    <div class="contactbar" id="contactBar"></div>

    <h1 id="heading">产品展示</h1>
    <p class="lead" id="sub">选择语言后会在全站生效；仅显示有内容的产品。</p>

    <div class="grid" id="grid"></div>
  </div>

  <footer>© <span id="y"></span> Eindeepseek</footer>

  <script>
    // i18n
    const I18N={
      zh:{title:'产品展示',sub:'选择语言后会在全站生效；仅显示有内容的产品。',groupTitle:'加入 WhatsApp 群组',groupDesc:'扫码二维码，进入我们的贸易 & 物流交流群。',email:'邮件',whats:'WhatsApp',phone:'电话',wechat:'微信'},
      en:{title:'Products',sub:'Language selection applies site-wide. Only products with content are shown.',groupTitle:'Join WhatsApp Group',groupDesc:'Scan the QR code to join our trade & logistics group.',email:'Email',whats:'WhatsApp',phone:'Phone',wechat:'WeChat'},
      de:{title:'Produkte',sub:'Die Sprachauswahl gilt für die ganze Seite. Es werden nur Produkte mit Inhalt angezeigt.',groupTitle:'WhatsApp‑Gruppe beitreten',groupDesc:'QR-Code scannen, um unserer Handels‑ & Logistik‑Gruppe beizutreten.',email:'E‑Mail',whats:'WhatsApp',phone:'Telefon',wechat:'WeChat'}
    };
    const qs=new URLSearchParams(location.search);
    const currentLang=(qs.get('lang')||localStorage.getItem('lang')||'zh').toLowerCase();
    localStorage.setItem('lang',currentLang);
    const t=I18N[currentLang]||I18N.zh;
    document.getElementById('heading').textContent=t.title;
    document.getElementById('sub').textContent=t.sub;
    // Lang buttons
    [...document.querySelectorAll('#langSwitcher button')].forEach(b=>{
      if(b.dataset.lang===currentLang) b.classList.add('active');
      b.onclick=()=>{const lang=b.dataset.lang;localStorage.setItem('lang',lang);const url=new URL(location.href);url.searchParams.set('lang',lang);location.href=url.toString();};
    });

    // Contact
    const CONTACT={email:'wengandy128@gmail.com',whatsapp:'+86 15888791812',phone:'+86 15888791812',wechat:'15888791812',waInvite:''};
    document.getElementById('contactBar').innerHTML=`
      <a href="mailto:${CONTACT.email}">📧 ${t.email}: ${CONTACT.email}</a>
      <a href="https://wa.me/${CONTACT.whatsapp.replace(/[^0-9]/g,'')}" target="_blank">💬 ${t.whats}</a>
      <a href="tel:${CONTACT.phone.replace(/\\s/g,'')}">📞 ${t.phone}: ${CONTACT.phone}</a>
      <span>🟩 ${t.wechat}: ${CONTACT.wechat}</span>
    `;

    // ======== 性能关键点：快速存在性检测 + 并行 ========
    // 1) 不再使用 HEAD，改为 GET，并设置 1.2s 超时
    function fetchWithTimeout(url,ms=1200){
      const ctl=new AbortController();
      const id=setTimeout(()=>ctl.abort(),ms);
      return fetch(url,{cache:'no-store',signal:ctl.signal}).finally(()=>clearTimeout(id));
    }
    async function existsFast(url){ try{ const r=await fetchWithTimeout(url); return r.ok; } catch { return false; } }

    // 2) 并行检查多后缀，谁先可用就用谁（Promise.any 方案）
    async function firstExisting(urls){
      const wrapped = urls.map(u => fetchWithTimeout(u).then(r => r.ok ? u : Promise.reject(u)));
      try{ return await Promise.any(wrapped); } catch { return ''; }
    }

    // 3) 首先优先把群卡片插入（感知更快）
    async function addGroupCard(){
      const candidates=['group.jpeg','group.jpg','group.png','group.webp'];
      const qr = await firstExisting(candidates);
      if(!qr) return;
      const grid=document.getElementById('grid');
      const a=document.createElement('a'); a.className='cardlink'; a.href=CONTACT.waInvite?CONTACT.waInvite:qr; a.target=CONTACT.waInvite?'_blank':'_self';
      a.innerHTML=`<article class="card" style="animation-delay:.05s">
        <div class="thumb" style="display:flex;align-items:center;justify-content:center">
          <img src="${qr}" alt="WhatsApp Group QR" class="qr-thumb" loading="eager" width="180" height="180">
        </div>
        <div class="body">
          <div class="title">${t.groupTitle}</div>
          <p class="desc">${t.groupDesc}</p>
        </div>
      </article>`;
      grid.appendChild(a);
    }

    // 4) 产品卡片并行生成（避免串行等待）
    async function addProductCards(){
      const grid=document.getElementById('grid');
      const tasks = Array.from({length:6}, (_,i)=>i+1).map(async i=>{
        const slug=`product-${i}`;
        const base=`assets/imgs/${slug}`;
        const img = await firstExisting([`${base}/1.jpg`,`${base}/1.jpeg`,`${base}/1.png`,`${base}/1.webp`]);
        // 预取文案（并行）
        const txtOrder=[currentLang,'en','zh','de'];
        const txtUrls=txtOrder.map(lg=>`products/${slug}-${lg}.txt`);
        const descPromise = (async () => {
          for (const u of txtUrls) {
            try { const r=await fetchWithTimeout(u); if(r.ok){ const tx=(await r.text()).trim(); const [first,...rest]=tx.split(/\\r?\\n/); return {title:first?.trim()||`Product ${i}`,desc:rest.join('\\n').trim()||''}; } } catch {}
          }
          return null;
        })();
        const preview = await descPromise;
        if(!img && !preview) return;

        const title=preview?.title||`Product ${i}`;
        const desc=preview?.desc||'';
        const href=`products/${slug}.html?lang=${encodeURIComponent(currentLang)}`;

        const a=document.createElement('a'); a.className='cardlink'; a.href=href;
        a.innerHTML=`<article class="card">
          ${img?`<img class="thumb" src="${img}" alt="${title}" loading="lazy">`:`<div class="thumb"></div>`}
          <div class="body"><div class="title">${title}</div><p class="desc">${desc}</p></div>
          <span class="badge">${currentLang.toUpperCase()}</span>
        </article>`;
        grid.appendChild(a);
      });
      await Promise.all(tasks);
    }

    // 先群卡片，再产品卡片（两者都在内部做并行）
    addGroupCard().then(addProductCards);

    document.getElementById('y').textContent=new Date().getFullYear();
  </script>
</body>
</html>
